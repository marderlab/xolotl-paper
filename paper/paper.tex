% !BIB TS-program = biber
\documentclass{frontiersSCNS} % for Science articles



\usepackage{graphicx}
%
\usepackage{amsmath} 
\usepackage{mathptmx}      % use Times fonts if available on your TeX system
%
\usepackage{color, soul}

\usepackage{caption}
\usepackage{float}
\floatstyle{plaintop}

\usepackage{hyperref}

% bibliography
\usepackage[english]{babel}
\usepackage{csquotes}
\usepackage[
backend=biber, 
bibencoding=utf8, 
style=authoryear, 
date=year, 
maxbibnames=6, 
minbibnames=6, 
url=false, 
isbn=false, 
eprint=false,
uniquename = false, 
autocite=inline]{biblatex}
\addbibresource{Bibliography.bib}

\usepackage[draft, nomargin, marginclue, footnote]{fixme}
\fxsetup{targetlayout=color}

% new commands and shortcuts
\usepackage{xspace}
\newcommand{\eg}{\textit{e.g.}\xspace}
\newcommand{\etal}{\textit{et al.}\xspace}
\newcommand{\ie}{\textit{i.e.}\xspace}
\newcommand{\etc}{\textit{etc.}\xspace}
\newcommand{\vs}{\textit{vs.}\xspace}
\newcommand{\viz}{\textit{viz.}\xspace}

% shortcut for float placing
\usepackage{placeins}

% make pretty MATLAB code
\usepackage{listings}
\usepackage{matlab-prettifier}
\lstMakeShortInline[style=Matlab-editor]"

% other nice features
\usepackage{lineno}
\linenumbers

\usepackage{xifthen}% provides \isempty test

\copyrightyear{}
\pubyear{}

\def\journal{Neuroinformatics}
\def\DOI{}
\def\articleType{Technology Report}
\def\keyFont{\fontsize{8}{11}\helveticabold }
\def\firstAuthorLast{Gorur-Shandilya, Hoyland \& Marder} 
\def\Authors{Srinivas Gorur-Shandilya\,$^{1*\dagger}$, Alec Hoyland\,$^{1\dagger}$, and Eve Marder$^{1}$}
\def\Address{$^{1}$Volen Center for Complex Systems and Biology Department \\ Brandeis University \\ Waltham, MA 02453 \\ USA
\vspace{0.25cm}

\vspace{0.5em}\tiny{$\dagger$ These authors have equally contributed to this article.}
}
\def\corrAuthor{Srinivas Gorur-Shandilya }
%\def\corrAddress{Marder Lab, Brandeis University, Biology Department and Volen Center for Complex Systems, Waltham, MA, USA}
\def\corrAddress{Volen Center for Complex Systems, Brandeis University, Waltham MA 02453}
\def\corrEmail{\texttt{srinivasgs@brandeis.edu}}

\newcommand{\dd}[1]{\mathrm{d}#1}

\begin{document}
\onecolumn
\firstpage{1}

\title[xolotl: neuron \& network simulator]{Xolotl: An Intuitive and Approachable Neuron \& Network Simulator in MATLAB}
\author[\firstAuthorLast ]{\Authors}
\address{}
\correspondance{}
\extraAuth{}
\topic{An Intuitive Neuronal Simulator}

\maketitle

\begin{abstract}
	

	Conductance-based models of neuron dynamics based on Hodgkin-Huxley formalism have been used extensively in computational neuroscience. However, working with these models continues to be a challenge due to their high dimensionality and large number of parameters, hindering intuition of their dynamical features. Here, we present a neuron and network simulator built on a novel automatic type system that binds class templates written in "C++" to object-oriented code in "MATLAB". Our approach builds on the tradition of uniting the speed and power of "C++" code with the ease-of-use and rich libraries of scientific programming languages like "MATLAB". In our software, models are hierarchical, with components that are named and searchable, permitting intuitive high-level programmatic control over all parameters. Our simulator's architecture allows for the live manipulation of any parameter in any model, and for visualizing the effects of changing that parameter immediately. The simulator is fully featured with hundreds of ion channel models from the electrophysiological literature, and can be easily extended to include arbitrary mechanisms and dynamics. Finally, the simulator is written in a modular fashion and has been released under a permissive free software license, enabling it to be integrated easily into the workflow of many researchers.
	
	\tiny
	\keyFont{ \section{Keywords:} simulator, code:MATLAB, code:C++, conductance-based, neuron, network, pedagogy}
	
\end{abstract}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  								%
%		INTRODUCTION 			%
% 		& OVERVIEW   			%
%								%
%								%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Introduction}
\label{sec:intro}

Nervous systems process and transmit information using electrically excitable membranes. Conductance-based models are a powerful biophysical simplification of an electrically excitable compartment in a neuron (\cite{hodgkinQuantitativeDescriptionMembrane1952}). Studies based on the Hodgkin-Huxley formalism now contribute significantly to mainstream research in small circuits (\cite{marderTheoryMotion1995, prinzComputationalApproachesNeuronal2010, prinzInsightsModelsRhythmic2006}). These models provide an approachable framework for understanding many salient principles of neuroscience, since they explicitly model cell membranes and ion channels as electrical components in a circuit. However, several challenges remain in working with biophysically-detailed conductance-based neuron models. First, these models can be high-dimensional with many nonlinear differential equations, with several parameters. Second, many or all equations in these models can be strongly coupled through variables like the membrane potential.  In multi-compartment models, membrane potentials in every compartment are coupled to each other. Finally, the choice of programming language used to implement the model imposes tradeoffs in designing and using neuron and network simulators: simulators written in languages like "C++", "FORTRAN" or "hoc" can integrate equations quickly, but often lack the ease-of-use and interoperability of those written in scientific programming languages like "Python", "Julia" or "MATLAB". 

Two major approaches have dominated the design of neuron simulators. First, some simulators, such as "NEURON" (\cite{hinesNEURONSimulationEnvironment1997}) are written in a fast compiled language like "C" and allow for the construction and simulation of neuron models using object-oriented paradigms. These simulators tend to perform fast computations with little overhead, but suffer from a steep learning curve. Wrapping these simulators in a more approachable language like "Python" and the use of graphical user interfaces (GUIs) mitigate these drawbacks, at the cost of obfuscating the underlying algorithms and parameters (\cite{bretteSimulationNetworksSpiking2007, hinesNEURONPython2009}). Another approach is to design simulators that can be used entirely in popular scientific programming languages. These simulators can be easier to use, and can benefit from inter-compatibility with other tools. Programs like "DynaSim" (\cite{sherfeyDynaSimMATLABToolbox2018}), "ANNarchy" (\cite{vitayANNarchyCodeGeneration2015}), "BRIAN" (\cite{stimbergBrianSecondComing2013}) allow the user to specify models using strings of equations that are specified in the scientific programming language, that can then be translated into a faster implementation language such as "C" or "C++" (\cite{stimbergEquationorientedSpecificationNeural2014}). This approach permits considerable flexibility for simulating systems of differential equations. Since models need to be translated between the two languages, the hierarchical nature of neuron models is not naturally encapsualted by these tools, and the syntax can be verbose. Neither approach facilitates the creation of tools that simultaneously maintain efficiency, ease-of-use, and clarity.

To overcome these design limitations, we have developed a novel automatic type system, "cpplab", which binds "MATLAB" code to "C++" header files. This architecture automatically creates objects in "MATLAB" that represent the underlying object-oriented "C++" code, without having to re-specify these objects in "MATLAB". In this paper, we introduce "xolotl", an implementation of the "cpplab" system specialized in integrating conductance-based neuron and network models. Models can be easily constructed from network building blocks in a few lines of "MATLAB" code using a hierarchical and intuitive syntax. Since models in the "MATLAB" workspace are automatically linked to models in the "C++" implementation, configuring these objects in "MATLAB" transparently configures the underlying "C++" objects. "xolotl" comes packaged with hundreds of components that can be used to assemble cells and networks;  has built-in visualization functions to inspect voltage time traces and activation functions; and a graphical user interface (GUI) for real-time manipulation of model parameters. The GUI permits real-time manipulation of any network parameter and an immediate visualization of the effect of that parameter on arbitrary dynamical features of the model. The ease-of-use of these tools lends them to pedagogical applications and the rapid prototyping of models. This tool aims to simplify the investigation of the dynamics of conductance-based network and neuron models, facilitate collaborative modeling, and is intended to complement other tools being developed in the computational neuroscience community.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%		DESIGN GOALS
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Design Goals}
\label{design}

"xolotl" is designed to be easy-to-use and richly featured while being fast enough to use in everyday research. Our focus was on designing an approchable simulator of conductance-based neurons and networks of these neurons; simulating arbitrary dynamical systems is therefore beyond the scope of this software. Specifically, the software was designed to simulate models of the form 


\begin{equation}
C_{i}\frac{dV_{i}}{dt}=-\sum_{j}I_{j} \label{eq:1}
\end{equation}

where \( C_{i} \) and  \( V_{i} \) are the capacitance and membrane potential of compartment  \( i \) and \( I_{j} \) is the current due to ion channel population \( j \) given by 

\begin{equation}
I_{j}=\bar{g}_{j}m_{j}^{p}h_{j}^{q}(V-E_{j})A_{i}  \label{eq:2}
\end{equation}

Here, \( \bar{g}_{j} \) is the maximal conductance, and \( E_{j} \) is the reversal potential of the ion channel population \( j \). \( A_{i} \) is the area of compartment \( i\) that contains these ion channels.  \( m_{j} \) and \( h_{j} \) are activation and inactivation variables that change according to

\begin{eqnarray*}
\tau_{m}\frac{dm}{dt}=m_{\infty}-m & \mathrm{and} & \tau_{h}\frac{dh}{dt}=h_{\infty}-h
\end{eqnarray*}

Typically, \( \tau_{m} \), \( \tau_{h} \), \( m_{\infty} \), and \( h_{\infty} \) are functions of the membrane potential \( V_{i} \). The software uses integration schemes that have been specifically developed to solve equations of this form (cite D\&A, Hines, others), though other schemes can be used if desired.   

This software is designed to be used from within "MATLAB", a scientific programming language common amongst neuroscientists and engineers for pedagogy and research. Our goal was to make "xolotl" completely usable entirely from within MATLAB, and fully scriptable. Models created using this simulator appear in the "MATLAB" workspace as native objects, and are thus fully compatible with the large library of toolboxes that "MATLAB" provides, allowing so the software to be used as a component of other packages and tools. All parameters of models and activation functions of any channel can be be inspected before running the model. We designed several features of the simulator to be easily extensible: adding custom conductances or synapse types is possible by changing a few lines in a template file. Finally, "xolotl" is designed to be fully auditable, and comes with several tools to verify model and parameter integrity and aid reproducibility. 



\subsection{Features}
\label{features}

\paragraph{A rich library of network components.} "xolotl" comes packaged with hundreds of pre-existing components (compartments, synapses, conductances, and controllers) that can be used as building blocks to construct model neurons and networks. Compartments represent sections of membrane with a single membrane potential, Calcium level, and set of constituent components; and can represent either entire cells or parts of cells. Conductances represent populations of ion channels in a compartment that produce transmembrane currents. Synapses connect two compartments together by introducing a current in the post-synaptic neuron that can depend on the voltage of the presynaptic neuron. Controllers represent intracellular mechanisms that integrate a Calcium-dependent signal from the compartment they are in and  change the properties of a conductance or synapse in response. 

\paragraph{Object-oriented.}
"xolotl" is designed to mirror the nested and hierarchical structure of networks and neurons. Biological neuronal networks are made up of neurons that are connected to each other with synapses. Each of these neurons contains within it a set of conductances and synaptic currents that contribute to its electrical behavior. These conductances can be controlled by intracellular regualtory system that can change their properties. Similarly, a "xolotl" model can contain a set of compartments that can represent individual neurons. Each compartment can contain a arbitrary set of conductances, that may be regulated by a set of controllers. All objects in the "xolotl" model tree (compartments, conductances, etc.) are bonafide "MATLAB" objects that have their own type, properties and associated methods. This object-oriented programming paradigm naturally represents the hierarchical structure of biological networks that contain neurons that contain populations of ion channels, and makes constructing and integrating these models easier. 

\paragraph{Automatic type system.}
Our approach to circumvent the tradeoff between high-performance but hard to use languages like "C++" and richly featured but slow languages like "MATLAB" was to construct an automatic type system that links object oriented code in "C++" to object oriented code in "MATLAB". This architecture lets us construct the core of the simulator in "C++", leveraging features of "C++" like pointers that are not commonly used in "MATLAB". A rudimentary way to make this "C++" code useable in "MATLAB" would be to re-write that code in "MATLAB" so that "MATLAB" objects can be bound their "C++" implementations. However, this approach is cumbersome, and prone to errors, since the same code needs to be written twice, in two languages. Instead, our automatic type system creates objects in "MATLAB" on-the-fly  from "C++" class specifications, obviating the need to rewrite code in "MATLAB" while preserving a tight coupling between objects in the "MATLAB" workspace and their "C++" implementation. The key advantages of this approach are that it makes developing new code much easier, and simplifies the task of constructing complex frameworks that span these two languages. 

\paragraph{Automatic hashing and compiling.}
Since every model requires a compiled binary to run, a potential stumbling block is the problem of unambiguously linking a model to a binary executable. "xolotl" solves this problem by hashing the "C++" header files of every component in the model recursively, allowing a model, no matter how complex, to be compactly represented by a short alphanumeric identifier (its "hash"). Compiled binaries are named using this hash, ensuring both that the correct binary is run to integrate the model, and that compilation occurs only as needed. This powerful feature enables the user experience to remain entirely within the "MATLAB" workspace, with compilation and selection of the correct binary occurring silently in the background. 


\subsection{Limitations}
\label{limitations}

Our focus on ease-of-use and speed means some features were intentionally neglected in the design process. 

\paragraph{Limited to conductance-based models.} "xolotl" has been developed specifically for conductance-based models. It does not currently support rate- or current-based models, or arbitrary dynamical systems. 

\paragraph{Limited numerical integration strategies.} Most components in the software are integrated using the exponential Euler method, which has been shown to perform well in neuronal models (\cite{ohErrorAnalysisSpecialized2006, dayanTheoreticalNeuroscience2001}. However, it may be desirable to use other methods under certain conditions. It is possible to introduce new network components that implement other integration schemes, or to modify the integration schemes of existing components, but that requires writing new "C++"  code, and is still restricted to integration schemes that assume a fixed step size. 

\paragraph{Inefficient tools for handling large networks.} "xolotl" was designed to work with small but complex networks and models, where every compartment and component is $named$, rather than numbered. It is more therefore suited towards simulating small and heterogeneous networks rather than large but homogenous networks. While the software $can$ integrate large networks ($>1000$ compartments), other tools are presumably more suited to this task.  

\paragraph{New mechanisms require new \texttt{C++} code.} Adding new network components requires writing new "C++" code. Adding a new conductance in the Hodgkin-Huxley formalism (\cite{hodgkinMeasurementCurrentvoltageRelations1952, dayanTheoreticalNeuroscience2001}), requires creating a new "C++" header file, though this is generally trivial. Implementing a new integration scheme or component type requires much more in-depth knowledge of the underlying "C++" core code.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%		USAGE EXAMPLES
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Usage Examples}
\label{usage}

In this section, we illustrate how "xolotl" can be used to generate a variety of models and simulate them. These examples have been chosen to illustrate various features of "xolotl", and are intended to serve as a template that researchers and educators can use for their own needs. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%		SIMULATING A HODGKIN-HUXLEY MODEL
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Simulating a Hodgkin-Huxley Model}

The axon of the giant squid contains contains a fast inactivating sodium conductance ("NaV"), a slower non-inactivating potassium conductance ("Kd"), and a passive leak current. Seminal work by Hodgkin and Huxley showed that depolarizations of the membrane, for example, by injecting current, could lead to an activation of the voltage-sensitive "NaV" channels, which led to a run away depolarization that was terminated by the inactivation of "NaV" channels and the activation of "Kd" channels that repolarized the membrane (\cite{hodgkinComponentsMembraneConductance1952, hodgkinMeasurementCurrentvoltageRelations1952}). As one of the simplest models of excitable neural mebranes, the Hodgkin-Huxley model often serves as a the first model introduced in pedagogical literature (cite some textbooks).  


\begin{figure}
	\centering
	\includegraphics[width=1.0\linewidth]{gfx/figure_HH}
	\caption{\texttt{xolotl} can quickly set up and simulate conductance-based models. Schematic representation of a electrotonically-compact neuron with three populations of ion channels (colored rectangles). In the simulator, the soma is represented using an object of class $compartment$ and the populations of ion channels are represented by $conductance$ objects contained within the compartment object. Code snippet used to set up this neuron model, inject current, integrate and plot the voltage, and show activation functions demonstrates how various several steps can be run in a few lines of code. (A) Simulated voltage trace of a Hodgkin-Huxley model with three conductances and 0.2 nA of injected current. Colors indicate the dominant current (gold is fast sodium (NaV), blue is delayed rectifier (Kd), red is Leak). (C) f-I curve of this neuron. (D-E) Steady-state gating functions for activation (m) and inactivation (h) gating variables. (F-I) Voltage-dependence of time constants for activation (m) and inactivation (h) gating variables}
	\label{fig:figurehh}
\end{figure}

In this section, we demonstrate how to simulate a Hodgkin-Huxley-like model, and how the tools built into our simulator make it easy to set up and integrate the model, and gain insight into the underlying biophysical mechanism. The schematic in Figure \ref{fig:figurehh} shows how the hierarchical structure of the ion channel populations within the soma is represented in the simulator, and how to create a compartment (here, labelled "HH") and add three populations of ion channels to it. These models of ion channels were obtained from \cite{liuModelNeuronActivitydependent1998} based on electrophysiological recordings from the lobster stomatogastric ganglion (\cite{turrigianoSelectiveRegulationCurrent1995}), and are part of the simulator. Adding an injected current and calling the built-in "plot" function plots the time series of membrane voltage. In the absence of injected current, the model is quiescent. When 0.2 nA is injected, the model tonically spikes (Figure \ref{fig:figurehh}A-B).  The \texttt{plot} function generates a voltage trace, which is colored by the dominant current (Figure \ref{fig:figurehh}A). Colors in the voltage trace indicate the strongest instantaneous inward current when the voltage is increasing, and strongest instantaneous outward current when the voltage is decreasing. These built-in features reveal that the dominant current during the upswing of every action potential is the sodium current, and the dominant current immediately after the peak of the action potential is the potassium current, but that the leak current contributes to depolarization following an action potential. This feature could be useful in quickly understanding the contributions of a number of ion channel types in a complex voltage trace from a more complicated neuron model. 

Integrating the model returns the voltage time series for every compartment: 

\begin{equation}
{\tt V = x.integrate;}
\end{equation}

The model can be integrated for various amplitudes of injected current to determine its f-I curve, or the relationship between injected current and its firing rate (cite). Figure \ref{fig:figurehh}C shows the f-I curve of this model, obtained by repeated integration of the model.  Finally, the built-in \texttt{show} function can plot activation ($m$) and inactivation ($h$) curves and voltage-dependent timescales of any channel type in the simulator (Figure \ref{fig:figurehh}D-G). These plots reveal that activation kinetics of the "NaV" channels are much faster than that of the "Kd" channels (Figure \ref{fig:figurehh}F), which facilitates the transient depolarization in an action potential. In summary, the simulator allows the user to construct and integrate this model in a few lines of code, and provides a rich visualization of the dynamics of the model. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%		VOLTAGE CLAMP
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




\subsection{Performing a Voltage Clamp Experiment \textit{in-silico}}

\begin{figure}[!htb]
	\centering
	\includegraphics[width=1.0\linewidth]{gfx/figure_clamp}
	\caption{Simulating a voltage-clamp experiment. The cartoon shows a cell with delayed rectifier potassium conductance (\cite{liuModelNeuronActivitydependent1998}) that is being recorded from in two-electrode voltage clamp. The code snippet sets up a model with a single compartment and a single channel type, and clamps the cell to a constant voltage and integrates it. (A) Voltage steps that the cell is clamped to. (B) Current injected into the cell to clamp it to the voltages in (A). (C) Asymptotic clamped current vs. clamped voltage for this cell. (D) Accounting for the reversal potential of Potassium ions yeilds the conductance-voltage curve of this channel type. (E) Normalized conductance-voltage curves, with sigmoid fits with various exponents. (F) An exponent of $n=4$ yields the best fit, allowing for the characterization of the activation function of this channel type. }
	\label{fig:figureclamp}
\end{figure}

Voltage clamping is a experimental technique where a amplifier is configured to inject the appropriate amount of current through a electrode to maintain the voltage of a cell at a desired value (cite D\&A). Under this paradigm, the membrane voltage is "clamped" or fixed to a desired value, permitting the study of voltage-dependent ion channels, since the sum of all currents through the population of ion channels in the cell is equal and opposite to the current injected by the clamp. By combining voltage clamp with the use of pharmacological agents to block all channels but the one of interest, the voltage-sensitivity of an ion channel population can be characterized. (insert all those citations as needed). 

"xolotl" can reproduce such a voltage clamp experiment $in silico$. Figure \ref{fig:figureclamp} illustrates how a simple model with a single compartment and a single ion channel type can be set up and clamped to a desired voltage.  Integrating the model yields the current required to clamp the cell at that voltage. Here, we use a delayed-rectifier potassium conductance (\cite{liuModelNeuronActivitydependent1998}) and simulate a voltage-clamp experiment whose goal is to infer the activation function of this channel. First, the cell is clamped to a number of different voltages (Fig. \ref{fig:figureclamp}A) and the resultant clamping currents are measured by integrating the model (Fig. \ref{fig:figureclamp}B). The asymptotic clamping currents depend on the clamping voltage in a nonlinear manner (Fig. \ref{fig:figureclamp}C), since the open probabilities of the channel are functions of the membrane voltage. Assuming the reversal potential is known, Eq. \eqref{eq:2} can be used to solve for the total conductance of the channel as a function of the clamping voltage (Fig. \ref{fig:figureclamp}D). Finally, a sigmoid can be fit to the normalized conductance-voltage curves to obtain the activiation function of the ion channel population (Fig. \ref{fig:figureclamp}E-F). "xolotl" can therefore be used to describe graphically the theoretical underpinnings of ion channel characterization through voltage clamp and can serve as an effective pedagogical tool in computational neuroscience.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%		NETWORK MODELS
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\subsection{Simulating Network Models}

\begin{figure}[!htb]
	\centering
	\includegraphics[width=1.0\linewidth]{gfx/figure_network}
	\caption{Simulating a network of conductance-based model neurons. (A) Diagram of a network model of the pyloric rhythm in the crustacean stomatogastric ganglion (Prinz \textit{et al.} 2004). (B) Each neuron is modeled as a single compartment with 7-8 intrinsic conductances and 1-3 post-synaptic conductances. (C) \texttt{xolotl} implements conductances as fields of compartments and synapses as connections between compartments. (D-F) Simulated voltage trace of a model network for the three compartments. (G) Time series of synaptic currents in the simulated network can be obtained from the integration.}
	\label{fig:figurenetwork}
\end{figure}

Network models in "xolotl" consist of compartment objects connected by synapses. Presynaptic and postsynaptic labels indicate the connectivity of the synapse. Figure \ref{fig:figurenetwork} implements a model of the triphasic pyloric rhythm in the stomatogastric ganglion of crustaceans (\cite{prinzSimilarNetworkActivity2004}). The pyloric model contains three compartments and seven synapses (Figure \ref{fig:figurenetwork}A). This structure is recapitulated in the hierarchy of the "xolotl" object, where conductances are contained within compartments (Figure \ref{fig:figurenetwork}B). Synapses are stored in a vector array as a field of the "xolotl" object in "MATLAB" (Figure \ref{fig:figurenetwork}C).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%		INTEGRAL CONTROL
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Simulating Homeostasis}

"xolotl" can implement homeostatic tuning rules as integral control. The controller computes an error signal (typically a function of intracellular calcium concentration), and adjusts the conductance or synapse it controls accordingly (\cite{olearyCorrelationsIonChannel2013}). In "xolotl", integral controllers are "cpplab" objects added to the conductance or synapse they regulate.

In a demonstration adapted from \cite{olearyCorrelationsIonChannel2013}, integral control changes maximal conductances to bring a neuron from quiescence into a bursting regime. Calcium sensors supervene on maximal conductance density (Figure \ref{fig:figureintegralcontrol}) to change neuronal activity. Each conductance in the "xolotl" structure contains a calcium-sensitive controller (Figure \ref{fig:figureintegralcontrol}B-C). Maximal conductances increase from random initial conditions to a set which elicits the desired network output by minimizing the error signal (Figure \ref{fig:figureintegralcontrol}D-F).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%		GRAPHICAL INTERFACE
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Using the GUI to manipulate parameters}


- failure of averaging
- complex interrelationships b/w parameters and dynamics
- not clear what parameter does what
- traditional approach: vary parameters, but for more than 2 D, how do you even visualize this? also slow. expensive to set up. 
- need something where parameter variation can be linked to dynamics, easy to set up, easy to use. 

The "manipulate" function opens the GUI which permits visualization of changing parameters in real-time. Moving sliders representing the values of network parameters updates a plot (Figure \ref{fig:puppeteerscreenshot}B). By default, the function opens a figure displaying the results of the "plot" function, which shows the voltage and intracellular calcium traces for each compartment (Figure \ref{fig:puppeteerscreenshot}A). "manipulate" grants slider control over all "xolotl" parameters by default, but specific ones can be selected by passing them as arguments.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%		BENCHMARKS
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Benchmarks}
\label{benchmarks}

To assess speed and accuracy, "xolotl", "DynaSim" (\cite{sherfeyDynaSimMATLABToolbox2018}), and "NEURON" (\cite{hinesNEURONSimulationEnvironment1997}) were compared in simulations over varied time resolution,  simulation time, and number of compartments (Figure \ref{fig:figurebenchmark}).

Single-compartment Hodgkin-Huxley-like models were generated using conductance dynamics from \cite{liuModelNeuronActivitydependent1998}) in the simulation environments. "xolotl" uses the exponential Euler method for integrating membrane potential (\cite{dayanTheoreticalNeuroscience2001}). "DynaSim" was implemented with a 2\textsuperscript{nd}-order Runge-Kutta integration scheme as recommended for high-performance in the documentation. "NEURON" used an implicit Euler regime (\cite{hinesNEURONSimulationEnvironment1997}).

To compare the integration methods, models were simulated for 5 s at varying time-resolution (Figure \ref{fig:figurebenchmark}A). The speed factor was defined as the ratio between time represented in the simulation and actual runtime (simulation-time). Therefore, the speed factor represents how many times faster the simulation is than a real-time observation. The coincidence factor determines the correlative overlap between two spike trains (\cite{jolivetBenchmarkTestQuantitative2008}). In this context, it is a measure of accuracy in the numerical simulation. Unity indicates perfect correlation. To assess accuracy over decreasing time-resolution for the three simulation environments, spike trains at each resolution were compared to a `canonical' spike train (exponential Euler at a time-step of $dt = 0.001$ ms). 

To assess the performance of the simulators in absence of set-up overhead, models were simulated with a time-resolution of $0.1$ ms over increasing simulation time (Figure \ref{fig:figurebenchmark}B).

Many simulators perform well in simulations of many compartments (\cite{bretteSimulationNetworksSpiking2007, sherfeyDynaSimMATLABToolbox2018, vitayANNarchyCodeGeneration2015, delormeSpikeNETEventdrivenSimulation2003}). To assess how "xolotl" under these conditions, networks of up to 1,000 Hodgkin-Huxley cells were simulated for 5 s at a time-resolution of 0.1 ms (Figure \ref{fig:figurebenchmark}C).

DESCRIBE BENCHMARK RESULTS

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%		DISCUSSION
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Discussion}
\label{discussion}

We set out to design a neuron and network simulator that could be useful in the classroom setting, especially for students of computational students, while also being powerful, fast and extensible enough to be used for research. By using a novel architecture that .., we showed how to create and simulate (1) single-compartment models of Hogkin-Huxley like neurons (Figure \ref{fig:figurehh}), (2) voltage clamp experiments and recover activation functions of single channel types (Figure 2), (3) a network of neurons with multiple synapse types (Figure 3), (4) a multi-compartment neuron model where the voltage of every compartment is coupled, and (5) a neuron model where homeostatic mechanisms control the maximal conductance of multiple channel types. 


\subsection{Design: components vs. equations in simulators }

- components from library vs. equations
- equations are transparent -- you know what you're solving. but clunky -- string parsing headaches, etc. 
- components are easy to assemble, but it;s hard to know where they are, how they can be changed, etc.
- xolotl goes the component route, but makes it very easy to find components (you can click your way into the C++ files). components are stored as source files, so you can modify it and immediately see it reflected in your model. we didn't invent another synatax for these components -- these are just C++ files. 

\subsection{Comparison with other simulators}

- compare with BRIAN, GENESIS, XPPAUT, NEURON, DynaSim
- selling point is ease of use and integration into MATLAB

\subsection{Auditability and Reproducability}

- reproducibility crisis in computational science 
- unlike experiemntal research, where reproducability can arise due to deep reasons, reasons for computational research irreproducability are mostly trivial: 
- multiple sources: software being used is closed-source, researcher's code is not made available; obscure architecture makes improper use possible. 
- how xolotl conributes to reoridubile science: (1) freely available, code for this paper available too for others to inspect and replicate (2) intutitive syntax, solid documentation. (3) architectural choices that ensure accountability: object hashing, parameter hashing possible. 


"xolotl" fosters reproducibility in science. While the availability of hosting sites with version control (\viz GitHub (\url{https://github.com}), GitLab (\url{https://gitlab.com/}), and Open Science Framework (\url{https://osf.io/})) and the push for reproducibility in computational science (\cite{eklundClusterFailureWhy2016, stoddenEnhancingReproducibilityComputational2016, bakerWhyScientistsMust2016}) has resulted in the availability of source code, much of this code base is bespoke and difficult to implement (\cite{sedanoCodeReadabilityTesting2016, xuMeasurementSourceCode2017}).

To this end, "xolotl" provides an environment with readability and reproducibility in mind. Each network is hashed to provide a unique alphanumeric identifier. Conductance header files are easily viewed in the "xolotl" source files; conductances in "MATLAB" contain links to the full path of the generating file.

\subsection{Circumventing Language Tradeoffs}

Executing "C/C++" code in higher-level languages such as "MATLAB" or "Python" often provides speed improvements for iterative code in algorithms. 

"C" is statically-typed, with procedural syntax that provides low-level access to memory (\cite{kernighanProgrammingLanguage1978}, providing significant advantages for time-intensive computations. Unfortunately, automatic code-generation is limited by the supervening language. "MATLAB", for instance, cannot use pointers or pass by reference, which limits the efficiency of "C" code automatically generated from "MATLAB". Conversely, custom "C/C++" code provides significant increases in performance and memory conservation, but lacks the ease-of-use and flexibility of scripting languages.

"xolotl" handles this problem through symbolic manipulation of "C++" objects in "MATLAB". Built from the ground up in "C++", "xolotl" maintains all the advantages of custom compiled code, but can run in "MATLAB" without the user having to touch the "C++" code. "xolotl" represents compartment, conductance, synapse, and controllers as "cpplab" objects, which template from underlying "C++" header files. In this way, properties of the "xolotl" network can be examined and changed using object-oriented paradigms. The object specifies the "integrate" function, not the other way around.

\subsection{Applications of the \texttt{cpplab} architecture}

NEED TO WRITE THIS




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%		PUBLICATION DETAILS
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section*{Conflict of Interest Statement}
%All financial, commercial or other relationships that might be perceived by the academic community as representing a potential conflict of interest must be disclosed. If no such relationship exists, authors will be asked to confirm the following statement: 

The authors declare that the research was conducted in the absence of any commercial or financial relationships that could be construed as a potential conflict of interest.

\section*{Author Contributions}

SG-S \& AH designed and wrote the software, and wrote the manuscript. AH created the online user documentation. EM supervised the project. All authors reviewed the paper.

\section*{Funding}

AH received funding from National Institute on Drug Abuse (NIDA) through the undergraduate training grant in computational neuroscience (1R90DA033463-01).

\section*{Acknowledgments}
The authors would like to thank Mara CP Rue and Hillary Rodgers for beta-testing the "xolotl" software. Janis Li helped to prepare many conductance header files.

\section*{Supplemental Data}
Tables including all conductances packaged with "xolotl" should be put in the supplementary material.

\section*{Data Availability Statement}

The code to generate all figures is available at (\url{https://github.com/marderlab/xolotl-paper}). "xolotl" is freely available at (\url{https://github.com/marderlab/xolotl}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%		BIBLIOGRAPHY
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\bibliographystyle{frontiersinSCNS&ENG} % for Science and Engineering articles
%\bibliography{Bibliography}   % name your BibTeX data base
\printbibliography

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%		FIGURES
%   (because it's 2018 and we still have this dumb system where all the figures are at the end. why? who knows
%   why can't they be in a more sensible place? it's not like we're not typesetting this ourselves. why do people
%   go out of their way to make papers unreadable? who actually likes the figures and the captions at the end, 
%   separated into their own pages?)
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%\section*{Figure captions}

\FloatBarrier






\begin{figure}
	\centering
	\includegraphics[width=1.0\linewidth]{gfx/figure_integral_control}
	\caption{Simulating neurons under homeostatic regulation. (A) Cartoon of a model neuron (\cite{liuModelNeuronActivitydependent1998} with integral control (\cite{olearyCorrelationsIonChannel2013}. (B) Hierarchical structure of a neuronal network considers controllers as components of compartments which act on conductances. (C) \texttt{xolotl} implements controllers as properties of conductances and synapses. (D) Calcium sensors change maximal conductances to move a neuron from quiescence to a bursting state. (E) Voltage trace shows regular bursting activity after integral control.}
	\label{fig:figureintegralcontrol}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=1.0\linewidth]{gfx/puppeteer_screenshot}
	\caption{Using the GUI to manipulate neuron parameters. (A) Real-time output of the \texttt{plot} function displaying voltage (colored) and intracellular calcium (black) traces of a bursting neuron model (\cite{prinzAlternativeHandtuningConductancebased2003, prinzSimilarNetworkActivity2004}. Colors indicate the dominant current. (B) Sliders control the maximal conductances, which updates on the figure.}
	\label{fig:puppeteerscreenshot}
\end{figure}


\begin{figure}
	\centering
	\includegraphics[width=1.0\linewidth]{gfx/figure_benchmark}
	\caption{\texttt{xolotl} benchmarked against \texttt{DynaSim} and \texttt{NEURON}. (A) Ratio of 'simulated' time to runtime (speed factor) and accuracy, measured by spike train coincidence plotted against decreasing time-resolution. (B) Speed factor for models at increasing simulation times. (C) Speed factor over number of compartments.}
	\label{fig:figurebenchmark}
\end{figure}


\end{document}